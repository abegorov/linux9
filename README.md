# Vagrant стенд для NFS

## Задание

- **vagrant** up должен поднимать 2 виртуалки: сервер и клиент;
- на сервере должна быть настроена директория для отдачи по **NFS**;
- на клиенте она должна автоматически монтироваться при старте (**fstab** или **autofs**);
- в сетевой директории должна быть папка **upload** с правами на запись;
- настроить аутентификацию через **KERBEROS (NFSv4)**.

## Реализация

Поскольку используется аутентификация через **Kerberos**, то сервер настроен на поддержку исключительно **NFS** версии **4.2**. Общая директория создаётся на сервере в **/srv/share** и монтируется в **/media/share**.

В **Vagrantfile** создаётся две виртуальные машины:

- **nfs-server**, **CentOS 9 Stream**, **IP:** 192.168.56.10;
- **nfs-client**, **CentOS 9 Stream**, **IP:** 192.168.56.11.

Настройка выполняется с помощью **Ansible**, для чего написаны пять ролей:

- **krb5-workstation** (выполняется на **nfs-client** и **nfs-server**);
- **nfs-utils** (выполняется на **nfs-client** и **nfs-server**);
- **krb5-server** (выполняется на **nfs-server**);
- **nfs-server** (выполняется на **nfs-server**);
- **nfs-client** (выполняется на **nfs-client**).

Роль **krb5-workstation** ставит и настраивает **krb5-workstation**.

Роль **nfs-utils** ставит **nfs-utils** и настраивает соответствие между именами **Kerberos** и именами учётных записей системы в **idmapd.conf**

Роль **krb5-server**:

1. Устанавливает **krb5-server** и настраивает **Key Destribution Center (KDC)**.
2. Генерирует мастер пароль для базы данных **KDC**, сохраняет его в **creds/kdc-master.txt** и создаёт базу данных **KDC** в **/var/kerberos/krb5kdc/principal**.
3. Создаёт учётные записи **root/admin** (администратор **KDC**), **vagrant** (пользователь **NFS**), **host/nfs-server** (учётная запись для **NFS** сервера, когда он выступает в качестве клиента **NFS**), **host/nfs-client** (учётная запись для **NFS** клиента), **nfs/nfs-server** (учётная запись для **NFS** сервера, когда он выступает в качестве сервера). Пароль от учётной записи **root/admin** сохраняется в файле **creds/root-pwd.txt**.
4. Разрешает в сервисы **kerberos** и **kadmin** в настройка **firewalld**.

Роль **nfs-server**:

1. Отключает в **nfs.conf** все весрии, кроме **4.2**.
2. Создаёт директории **/srv/share** и **/srv/share/upload** с нужными правами. Разрешает всем читать файлы в **/srv/share** (без изменения) и разрешает **vagrant** записывать файлы в **/srv/share/upload**.
3. Экспортирует директорию **/srv/share** в **NFS**, подключение разрешается только с использованием **Kerberos** с шифрованием всего трафика (**sec=krb5p**).
4. Добавляет учётные записи **nfs/nfs-server** и **host/nfs-server** в **/etc/krb5.keytab**.
5. Включает и запускает службу **nfs-server** и разрешает её в правилах **firewalld**.

Роль **nfs-client**:

1. Добавляет **nfs-server** в **/etc/hosts** (без этого **Kerberos** аутентификация не будет работать).
2. Добавляет учётную запись **host/nfs-client** в **/etc/krb5.keytab**.
3. Добавляет учётную запись **vagrant** в **/home/vagrant/.keytab**.
4. Прописывает автоматическое получение **Kerberos** токена при входе пользователя **vagrant** в **.bashrc** (выполняется **kinit "${USER}" -k -t "${HOME}/.keytab**).
5. Запускает **rpc-gssd.service**, так как он не запускается автоматически и без него **Kerberos** аутентификация не работает.
6. Создаёт директорию **/media/share** и настраивает её автоматическое монтирование, через **systemd.automount**.

## Переменные

Переменные определены в файле **group_vars/all.yml**:

- **krb_domain** - название домена **Kerberos**;
- **krb_realm** - **Kerberos Realm** (название домена в верхнем регистре);
- **krb_kdc_ip** - **IP** адрес сервера **KDC**, должен совпадать с **IP** адресом **nfs-server**;
- **nfs_server_ip** - **IP** адрес **nfs-server**;
- **nfs_share_dir** - путь к общей директории на **nfs-server**;
- **nfs_share_mountpoint** - точка монтирования общей директории на клиенте;
- **nfs_share_mountname** - имя для **mount** и **automount** на клиенте, получается из **nfs_share_mountpoint** путём замены слеша на тире.

## Запуск

Для запуска и проверки достаточно выполнить следующие команды (необходимо обязательно проверять под пользователем **vagrant**, так как у пользователя **root** отсутствуют права на эту директорию):

```shell
vagrant up
vagrant ssh nfs-client
cd /media/share/upload
touch file
ls -la
mount | grep /media/share
```

Наличие билета **Keberos** можно проверить командой **klist**, для получения нового билета достаточно выполнить **kinit vagrant -k -t /home/vagrant/.keytab**. Консоль администрирования **Kerberos** доступна по команде **kadmin -p root/admin**, пароль указан в файле **creds/root-pwd.txt**.

Протестировано с:

- Vagrant 2.3.7
- Ansible 2.16.8
- Python 3.11.9
- Jinja2 3.1.4
